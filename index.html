<!DOCTYPE html>
<html>
    <head>
        <title>Bucket List</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            table, th, td { border: 1px solid; border-collapse: collapse; padding: 5px; }
            #status_message { white-space: pre-wrap; margin-top: 10px; font-family: monospace; }
        </style>
    </head>
    <body>
        <div class="upload-section">
            <h3>Upload New File</h3>
            <div>
                <label for="file_input">File: </label>
                <input type="file" id="file_input">
            </div>
            <div style="margin-top: 5px;">
                <label for="description_input">Description: </label>
                <input type="text" id="description_input" placeholder="Enter file description">
            </div>
            <button id="upload_button" onclick="uploadObject()" style="margin-top: 10px;">Upload</button>
            <div id="status_message"></div>
        </div>

        <div><h1>Bucket List</h1></div>
        <div>
            <table id="objectsTable"></table>
        </div>
        <div>
            <img src="" id="download_image" style="max-width: 300px; margin-top: 20px;">
        </div>

        <script>
            // --- CONFIGURATION ---
            const ORCHESTRATOR_URL = "https://of4mh4f3bcs2y3gpztw2jujui40lviuj.lambda-url.ap-southeast-2.on.aws/"; 
            const LIST_URL = "https://xjok7sqel75h3hshg7doevb4xq0fqlwe.lambda-url.ap-southeast-2.on.aws/";
            const DOWNLOAD_URL = "https://7jrbw2fn3ucpwdnfqh32kgdbgy0upgsk.lambda-url.ap-southeast-2.on.aws/";
            const DELETE_URL = "https://3i2keqr3yusmwnxqqdf2wcwude0viyim.lambda-url.ap-southeast-2.on.aws/";
            const THUMBNAIL_URL = "https://d7ei42hx6l26ofukqnrtijzgce0wltmo.lambda-url.ap-southeast-2.on.aws/"; 

            // Initialize List
            fetchListOfObjects();

            // --- UPLOAD LOGIC ---
            function uploadObject() {
                let file_input = document.getElementById("file_input");
                let desc_input = document.getElementById("description_input");
                let status_div = document.getElementById("status_message");
                
                if (file_input.files.length === 0) {
                    alert("Please select a file first.");
                    return;
                }

                let file = file_input.files[0];
                let description = desc_input.value;
                status_div.innerText = "Processing upload...";

                let reader = new FileReader();
                reader.onload = () => {
                    const uint8Array = new Uint8Array(reader.result);
                    
                    const body = {
                        "content": uint8Array.toBase64(),
                        "key": file.name,
                        "description": description
                    };
                    
                    sendToOrchestrator(body);
                };
                reader.onerror = (e) => {
                    console.log('Error : ' + e.type);
                    status_div.innerText = "Error reading file.";
                };
                reader.readAsArrayBuffer(file);  
            }

            function sendToOrchestrator(jsonBody) {
                let status_div = document.getElementById("status_message");

                fetch(ORCHESTRATOR_URL, {
                     method: 'POST',
                     body: JSON.stringify(jsonBody),
                     headers: { 'Content-Type': 'application/json' }
                })
                .then((resp) => resp.json()) 
                .then(function(response) {
                    console.info('Orchestrator Response:', response);
                    status_div.innerText = JSON.stringify(response, null, 4);
                    fetchListOfObjects();
                })
                .catch(error => {
                    console.error('Upload Error:', error);
                    status_div.innerText = "Upload Failed: " + error.message;
                });
            }

            // --- DELETE LOGIC (UPDATED) ---
            function deleteObject(key) {
                let status_div = document.getElementById("status_message");
                
                // 1. Update status to show we are working
                status_div.innerText = "Processing delete for " + key + "...";

                const body = { "key": key };
                fetch(DELETE_URL, {
                    method: 'DELETE', 
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    // 2. We now expect JSON back from the orchestrator
                    return response.json(); 
                })
                .then(jsonResponse => {
                    console.log('Delete successful', jsonResponse);
                    
                    // 3. Display the detailed report from the Orchestrator
                    status_div.innerText = JSON.stringify(jsonResponse, null, 4);
                    
                    // 4. Refresh the table
                    fetchListOfObjects();
                })
                .catch(error => {
                    console.error('Error deleting:', error.message);
                    status_div.innerText = "Delete Failed: " + error.message;
                });
            }

            // --- LIST & THUMBNAIL LOGIC ---
            function fetchListOfObjects() {
                fetch(LIST_URL)
                        .then((response) => {
                            if (!response.ok) throw new Error(`HTTP error, status = ${response.status}`);
                            return response.text();
                        })
                        .then((text) => renderListOfObjects(text))
                        .catch((error) => console.log(`Error: ${error.message}`));
            }

            function renderListOfObjects(listOfObjects) {
                let objectsTable = document.getElementById("objectsTable");
                while (objectsTable.firstChild) {
                    objectsTable.removeChild(objectsTable.lastChild);
                }
                let objectsArray = JSON.parse(listOfObjects);

                for (let i = 0; i < objectsArray.length; i++) {
                    let row = document.createElement("tr");

                    // Thumbnail Column
                    let thumbCell = document.createElement("td");
                    let thumbImg = document.createElement("img");
                    thumbImg.style.width = "50px"; 
                    thumbImg.style.height = "auto";
                    thumbImg.alt = "Loading...";
                    fetchThumbnail(objectsArray[i].key, thumbImg);
                    thumbCell.appendChild(thumbImg);
                    row.appendChild(thumbCell);

                    // Key Column
                    let keyCell = document.createElement("td");
                    keyCell.innerText = objectsArray[i].key;
                    row.appendChild(keyCell);

                    // Download Column
                    let downloadCell = document.createElement("td");
                    let downloadButton = document.createElement("button");
                    downloadButton.addEventListener("click", function () {
                        fetchObject(objectsArray[i].key)
                    });
                    downloadButton.innerHTML = "Download";
                    downloadCell.appendChild(downloadButton);
                    row.appendChild(downloadCell);

                    // Delete Column
                    let deleteCell = document.createElement("td");
                    let deleteButton = document.createElement("button");
                    deleteButton.addEventListener("click", function () {
                        deleteObject(objectsArray[i].key);
                    });
                    deleteButton.innerHTML = "Delete";
                    deleteCell.appendChild(deleteButton);
                    row.appendChild(deleteCell);

                    objectsTable.appendChild(row);
                }
            }

            function fetchThumbnail(key, imgElement) {
                fetch(THUMBNAIL_URL, {
                    method: 'POST',
                    body: JSON.stringify({ "key": key }),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (!response.ok) throw new Error("No thumbnail");
                    return response.blob();
                })
                .then(blob => {
                    const objectURL = URL.createObjectURL(blob);
                    imgElement.src = objectURL;
                })
                .catch(err => {
                    // console.log("Thumbnail error for " + key, err);
                    imgElement.alt = "No Img"; 
                });
            } 

            // --- DOWNLOAD LOGIC ---
            function fetchObject(key) {
                const body = { "key": key };
                fetch(DOWNLOAD_URL, {
                            method: 'PUT',
                            body: JSON.stringify(body)
                        })
                        .then(response => response.blob())
                        .then((myBlob) => {
                            const objectURL = URL.createObjectURL(myBlob);
                            document.getElementById("download_image").src = objectURL;
                        });
            }

            // --- UTILS ---
            if (!Uint8Array.prototype.toBase64) {
                Uint8Array.prototype.toBase64 = function() {
                    let binary = '';
                    let len = this.byteLength;
                    for (let i = 0; i < len; i++) {
                        binary += String.fromCharCode(this[i]);
                    }
                    return window.btoa(binary);
                }
            }
        </script>
    </body>
</html>
